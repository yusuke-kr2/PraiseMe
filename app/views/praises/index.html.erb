<div class="record-wrapper">

  <div class="record-card">

    <h1 class="record-title">褒め声を投稿しよう</h1>

    <!-- 録音トグルボタン -->
    <div class="record-container">
      <button id="recordToggleButton" class="record-btn">
        <img id="recordIcon" src="<%= asset_path('my_icon.jpg') %>" class="record-icon">
      </button>
      <p id="recordLabel" class="record-label">録音開始</p>
    </div>

    <!-- 録音データ送信フォーム -->
    <%= form_with model: @praise, local: true, html: { multipart: true, id: "praiseForm" } do |f| %>
      <%= f.file_field :audio, id: "audioInput", class: "hidden-audio" %>
    <% end %>

  </div>


  <div class="record-list-card">
    <h2 class="record-list-title">褒め声一覧</h2>

    <% @praises.each do |p| %>
      <div class="record-item">

        <p class="record-nickname"><strong><%= p.user.nickname %> :</strong></p>

        <% if p.audio.attached? %>
          <%= audio_tag p.audio, controls: true, class: "record-audio" %>
        <% end %>

        <% if p.user_id == session[:user_id] %>
          <%= link_to "削除",
                praise_path(p),
                data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
                class: "delete-btn" %>
        <% end %>
      </div>
    <% end %>
  </div>

</div>

<script>
let mediaRecorder;
let audioChunks = [];

const recordButton = document.getElementById("recordButton");
const stopButton = document.getElementById("stopButton");
const audioInput = document.getElementById("audioInput");
const form = document.getElementById("praiseForm");

recordButton.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();
  audioChunks = [];

  mediaRecorder.ondataavailable = e => {
    audioChunks.push(e.data);
  };

  recordButton.disabled = true;
  stopButton.disabled = false;
};

stopButton.onclick = () => {
  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const file = new File([audioBlob], "praise.wav", { type: 'audio/wav' });

    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    audioInput.files = dataTransfer.files;

    form.submit();
  };

  recordButton.disabled = false;
  stopButton.disabled = true;
};
</script>
