<h1>褒め声を投稿しよう</h1>

<!-- 録音ボタン -->
<button id="recordButton">録音開始</button>
<button id="stopButton" disabled>録音停止</button>

<!-- フォーム -->
<%= form_with model: @praise, local: true, html: { multipart: true, id: "praiseForm" } do |f| %>
  <%= f.file_field :audio, id: "audioInput", style: "display:none;" %>
<% end %>

<h2>褒め声一覧</h2>

<% @praises.each do |p| %>
  <div style="margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px;">

    <p><strong><%= p.user.nickname %>:</strong></p>

    <% if p.audio.attached? %>
      <%= audio_tag p.audio, controls: true %>
    <% end %>

    <%# 自分の投稿だけ削除可能にする（任意） %>
    <% if p.user_id == session[:user_id] %>
      <%= link_to "削除",
            praise_path(p),
            data: { turbo_method: :delete, turbo_confirm: "本当に削除しますか？" },
            class: "btn btn-danger",
            style: "margin-top: 5px;" %>
    <% end %>

  </div>
<% end %>


<script>
let mediaRecorder;
let audioChunks = [];

const recordButton = document.getElementById("recordButton");
const stopButton = document.getElementById("stopButton");
const audioInput = document.getElementById("audioInput");
const form = document.getElementById("praiseForm");

recordButton.onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();
  audioChunks = [];

  mediaRecorder.ondataavailable = e => {
    audioChunks.push(e.data);
  };

  recordButton.disabled = true;
  stopButton.disabled = false;
};

stopButton.onclick = () => {
  mediaRecorder.stop();
  mediaRecorder.onstop = () => {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });

    // ActiveStorage用にFileオブジェクトを作ってformにセット
    const file = new File([audioBlob], "praise.wav", { type: 'audio/wav' });

    // Railsフォームにセット
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    audioInput.files = dataTransfer.files;

    form.submit();
  };

  recordButton.disabled = false;
  stopButton.disabled = true;
};
</script>


